{% extends 'base.html' %}
{% block title %}{% if tipo == 'receita' %}Receitas Fixas{% else %}Despesas Fixas{% endif %} - FinançasPro{% endblock %}

{% block content %}
<section class="page-section">
    <div class="page-header">
        <div>
            <h1><i
                    class="fas {% if tipo == 'receita' %}fa-hand-holding-usd{% else %}fa-file-invoice-dollar{% endif %}"></i>
                {% if tipo == 'receita' %}Receitas Fixas{% else %}Despesas Fixas{% endif %}</h1>
            <p class="page-subtitle">Gerencie suas {% if tipo == 'receita' %}receitas mensais{% else %}contas mensais e
                despesas recorrentes{% endif %}</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('addDespesaModal')">
            <i class="fas fa-plus"></i> {% if tipo == 'receita' %}Nova Receita Fixa{% else %}Nova Despesa Fixa{% endif
            %}
        </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid stats-grid-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(124, 92, 252, 0.15); color: #7c5cfc;">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total Fixo / Mês</span>
                <span class="stat-value">{{ total_fixo|brl }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">{% if tipo == 'receita' %}Recebido{% else %}Pago{% endif %} este Mês</span>
                <span class="stat-value text-green">{{ total_pago|brl }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-red">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Pendente</span>
                <span class="stat-value text-red">{{ total_pendente|brl }}</span>
            </div>
        </div>
    </div>

    <!-- List -->
    {% if despesas %}
    <div class="table-card">
        <div class="table-header">
            <h2><i class="fas fa-list"></i> Suas {% if tipo == 'receita' %}Receitas Fixas{% else %}Despesas Fixas{%
                endif %}</h2>
            <span class="badge">{{ despesas|length }} cadastradas</span>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in despesas %}
                    <tr class="fade-in-row">
                        <td>
                            <strong>{{ d.nome }}</strong>
                            {% if d.conta %}
                            <br><small class="text-muted"><i class="fas {{ d.conta.icone }}"></i> {{ d.conta.nome
                                }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if d.categoria_rel %}
                            <span class="cat-badge">
                                <i class="fas {{ d.categoria_rel.icone }}" style="color: {{ d.categoria_rel.cor }}"></i>
                                {{ d.categoria_nome }}
                            </span>
                            {% else %}
                            <span class="cat-badge">—</span>
                            {% endif %}
                        </td>
                        <td class="td-valor {% if tipo == 'receita' %}text-green{% else %}text-red{% endif %}">{{
                            d.valor|brl }}</td>
                        <td>Todo dia <strong>{{ d.dia_vencimento }}</strong></td>
                        <td>
                            {% set status = d.status_atual %}
                            <span class="status-badge status-{{ status }}">
                                {% if status == 'pago' %}
                                <i class="fas fa-check-circle"></i> Pago
                                {% elif status == 'atrasado' %}
                                <i class="fas fa-exclamation-circle"></i> Atrasado
                                {% elif status == 'proximo' %}
                                <i class="fas fa-clock"></i> Próximo
                                {% else %}
                                <i class="fas fa-hourglass-half"></i> Pendente
                                {% endif %}
                            </span>
                        </td>
                        <td class="td-actions">
                            {% if not d.pago_no_mes(hoje.year, hoje.month) %}
                            <form action="{{ url_for('pagar_transacao_fixa', id=d.id) }}" method="POST"
                                class="inline-form">
                                <button type="submit" class="btn btn-sm btn-primary"
                                    title="{% if tipo == 'receita' %}Marcar como recebida{% else %}Marcar como paga{% endif %}">
                                    <i class="fas fa-check"></i> {% if tipo == 'receita' %}Receber{% else %}Pagar{%
                                    endif %}
                                </button>
                            </form>
                            {% endif %}
                            <form action="{{ url_for('excluir_transacao_fixa', id=d.id) }}" method="POST"
                                class="inline-form" onsubmit="return confirm('Excluir {{ d.nome }}?')">
                                <button type="submit" class="btn-icon btn-icon-delete" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="empty-state-page">
        <div class="empty-icon"><i
                class="fas {% if tipo == 'receita' %}fa-hand-holding-usd{% else %}fa-file-invoice-dollar{% endif %}"></i>
        </div>
        <h3>Nenhuma {% if tipo == 'receita' %}receita{% else %}despesa{% endif %} fixa cadastrada</h3>
        <p>Cadastre {% if tipo == 'receita' %}salários, rendas extras, etc.{% else %}contas como aluguel, internet,
            streaming, etc.{% endif %}</p>
        <button class="btn btn-primary" onclick="openModal('addDespesaModal')">
            <i class="fas fa-plus"></i> Cadastrar {% if tipo == 'receita' %}Receita Fixa{% else %}Despesa Fixa{% endif
            %}
        </button>
    </div>
    {% endif %}
</section>

<!-- Modal -->
<div class="modal-overlay" id="addDespesaModal">
    <div class="modal">
        <div class="modal-header">
            <h2><i
                    class="fas {% if tipo == 'receita' %}fa-hand-holding-usd{% else %}fa-file-invoice-dollar{% endif %}"></i>
                Nova {% if tipo == 'receita' %}Receita{% else %}Despesa{% endif %} Fixa</h2>
            <button class="modal-close" onclick="closeModal('addDespesaModal')"><i class="fas fa-times"></i></button>
        </div>
        <form action="{{ url_for('nova_transacao_fixa') }}" method="POST" class="modal-form">
            <input type="hidden" name="tipo" value="{{ tipo }}">
            <div class="form-group">
                <label>Nome da {% if tipo == 'receita' %}Receita{% else %}Despesa{% endif %}</label>
                <input type="text" name="nome"
                    placeholder="{% if tipo == 'receita' %}Ex: Salário, Mesada...{% else %}Ex: Aluguel, Internet, Netflix...{% endif %}"
                    required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" name="valor" step="0.01" min="0.01" placeholder="0,00" required>
                </div>
                <div class="form-group">
                    <label>Dia do Vencimento</label>
                    <input type="number" name="dia_vencimento" min="1" max="31" placeholder="1-31" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <select name="categoria_id">
                        <option value="">Selecione...</option>
                        {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Conta {% if tipo == 'receita' %}de Destino{% else %}de Pagamento{% endif %}</label>
                    <select name="conta_id">
                        <option value="">Selecione...</option>
                        {% for c in contas %}
                        <option value="{{ c.id }}">{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-check"></i> Cadastrar
            </button>
        </form>
    </div>
</div>
{% endblock %}