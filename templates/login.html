{% extends 'base.html' %}
{% block title %}Login - FinançasPro{% endblock %}

{% block content %}
<section class="auth-section">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-icon">
                <i class="fas fa-envelope-open-text"></i>
            </div>
            <h1>Acesso Seguro</h1>
            <p>Faça login recebendo um código no seu e-mail</p>
        </div>
        
        <!-- Passo 1: Solicitar Código -->
        <form id="request-code-form" class="auth-form">
            <div class="form-group">
                <label for="email">
                    <i class="fas fa-envelope"></i> Email
                </label>
                <input type="email" id="email" name="email" placeholder="seu@email.com" required autocomplete="email">
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="btn-request">
                <i class="fas fa-paper-plane"></i> Enviar Código
            </button>
            <div id="request-msg" class="form-msg" style="margin-top: 10px; font-size: 0.9em; text-align: center;"></div>
        </form>

        <!-- Passo 2: Verificar Código (Oculto inicialmente) -->
        <form id="verify-code-form" class="auth-form" style="display: none;">
            <div class="form-group">
                <label for="codigo">
                    <i class="fas fa-key"></i> Código de Verificação
                </label>
                <input type="text" id="codigo" name="codigo" placeholder="000000" maxlength="6" required style="text-align: center; font-size: 1.5rem; letter-spacing: 5px;">
                <small style="display: block; margin-top: 5px; color: var(--text-secondary);">Verifique a caixa de entrada (e spam) do e-mail informado.</small>
            </div>
            <button type="submit" class="btn btn-primary btn-block" id="btn-verify">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            <div id="verify-msg" class="form-msg" style="margin-top: 10px; font-size: 0.9em; text-align: center;"></div>
        </form>
        
        <div class="auth-footer">
            <p>Não tem conta? <a href="{{ url_for('cadastro') }}">Criar conta grátis</a></p>
        </div>
    </div>
</section>

<script>
document.getElementById('request-code-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('btn-request');
    const msgDiv = document.getElementById('request-msg');
    const email = document.getElementById('email').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    msgDiv.textContent = '';
    msgDiv.style.color = '';
    
    try {
        const res = await fetch('/api/login/request_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
        });
        const data = await res.json();
        
        if (data.status === 'success') {
            document.getElementById('request-code-form').style.display = 'none';
            document.getElementById('verify-code-form').style.display = 'block';
            document.getElementById('codigo').focus();
        } else {
            msgDiv.textContent = data.message || 'Erro ao enviar código.';
            msgDiv.style.color = '#ff6b6b';
        }
    } catch(err) {
        msgDiv.textContent = 'Erro de conexao. Tente novamente.';
        msgDiv.style.color = '#ff6b6b';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Código';
    }
});

document.getElementById('verify-code-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('btn-verify');
    const msgDiv = document.getElementById('verify-msg');
    const email = document.getElementById('email').value;
    const codigo = document.getElementById('codigo').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
    msgDiv.textContent = '';
    msgDiv.style.color = '';
    
    try {
        const res = await fetch('/api/login/verify_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, codigo: codigo})
        });
        const data = await res.json();
        
        if (data.status === 'success') {
            msgDiv.textContent = 'Login aprovado! Redirecionando...';
            msgDiv.style.color = '#00d68f';
            setTimeout(() => {
                window.location.href = "{{ request.args.get('next') or url_for('dashboard') }}";
            }, 800);
        } else {
            msgDiv.textContent = data.message || 'Código inválido.';
            msgDiv.style.color = '#ff6b6b';
        }
    } catch(err) {
        msgDiv.textContent = 'Erro de conexao.';
        msgDiv.style.color = '#ff6b6b';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
    }
});
</script>
{% endblock %}